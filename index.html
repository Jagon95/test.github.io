<html>
<head>

    <style>

    </style>
    <!--<link type="text/css" rel="stylesheet" href="friends.css">-->
    <!--<link type="text/css" rel="stylesheet" href="common.css">-->
    <link type="text/css" rel="stylesheet" href="style.css">
</head>
<body>
<script language="javascript">

    const TOKEN = '339517a7c1ac087d5dc9f031eedeedb76a8640ba6e28dae2e438fb48f62dab355d4d7694b2244d557e667';

    const FRIEND_TEMPLATE = `<div class="friends_user_row clear_fix" id="friends_user_row{{id}}">
                            <div id="res{{id}}"></div>
                            <div class="friends_photo_wrap">
                                <a class="friends_photo _online" href="https://vk.com/id{{id}}"><img class="friends_photo_img"
                                                                                         alt="{{fullname}}"
                                                                                         src="{{photo}}"></a>
                            </div>
                            <div class="friends_user_info">
                                <div class="friends_field friends_field_title"><a href="https://vk.com/id{{id}}">{{fullname}}</a>
                                </div>
                                <div class="friends_field">{{study}}</div>

                                <a href="https://vk.com/write{{id}}" class="friends_field_act"
                                   onclick="return showWriteMessageBox(event, {{id}})">Написать сообщение</a>
                            </div>
                        </div>`;


    function vkQueryBuilder(method, fields) {
        if(!method) throw new Error('Empty method');
        var query = 'https://api.vk.com/method/' + method + '?';
        var params = [];
        for(key in fields) {
            params.push(key + '=' + fields[key]);
        }
        return query + params.join('&');
    }

    function getJsonpData(method, options, callback) {
        var script = document.createElement('script');

        if(callback) {
            var callbackName = 'jsonpCallback' + Date.now();
            document[callbackName] = function (data) {
                callback(data);
                script.remove();
                delete document[callbackName];
            };

            options.callback = 'document.' + callbackName;
        }

        script.src = vkQueryBuilder(method, options);
        document.getElementsByTagName('head')[0].appendChild(script);
    }

    
    function renderElement(template, args) {
        var $ = template.match(/{{(.*?)}}/g);

        if (Array.isArray($)) {
            $.forEach(function (item) {
                item = item.replace("{{", "");
                item = item.replace("}}", "");
                if (args[item] === undefined){
                    console.warn("Переменная "+item+" не найдена");
                    template = template.replace("{{" + item + "}}", "null");
                } else {
                    template = template.replace("{{" + item + "}}", args[item]);
                }
            });
        }

        var wrapper = document.createElement('template');
        wrapper.innerHTML = template;
        return wrapper.content.firstChild;
    }

    function getFriends() {
        var fields = ['uid', 'first_name', 'last_name', 'nickname', 'photo', 'photo_medium', 'photo_big', 'has_mobile', 'rate', 'contacts', 'education'];
        friendList = document.getElementById('friends_container');
        getJsonpData('friends.get', {access_token: TOKEN, count: 100, fields: fields.join(',')}, function (data) {
            if(Array.isArray(data.response)) {
                document.getElementById("friend_list_wrapper").style.display = 'block';

                data.response.forEach(function (person) {
                    var options = {
                        fullname: person.first_name + ' ' + person.last_name,
                        photo: person.photo_medium,
                        study: person.faculty_name,
                        id: person.uid
                    };
                    friendList.appendChild(renderElement(FRIEND_TEMPLATE, options));
                })
            }
        });
    }

    rights = ['friends'];
    //https://oauth.vk.com/authorize?client_id=6054906&scope=rights.join(',')&redirect_uri=https://jagon95.github.io&display=page&response_type=token
    //https://oauth.vk.com/authorize?client_id=6054906&scope=friends&redirect_uri=http://oauth.vk.com/blank.html&display=page&response_type=token

    //cce4bc87ad9b7d36127a9884cb4bf131641ff41b85aa42967602761d8e0c247f2064032b68aa2d0abf904
    //    VK.Auth.getLoginStatus(authInfo);
    //    VK.UI.button('login_button');
    //    https://api.vk.com/method/METHOD_NAME?PARAMETERS&access_token=ACCESS_TOKEN

    function getToken() {
        xhr = new XMLHttpRequest();
        xhr.open('GET', 'https://oauth.vk.com/authorize?client_id=6054906&scope=friends&redirect_uri=http://oauth.vk.com/blank.html&display=page&response_type=token');
        xhr.onreadystatechange = function() {
            if (xhr.readyState != 4) return;

            if (xhr.status != 200) {
                alert(xhr.status + ': ' + xhr.statusText);
            } else {
                alert(xhr.responseText);
            }

        }
        xhr.send();
    }





    //если нет куки
        //кнопка авторизации
        //иначе авторизация



        //если хорошо - рисуем блок с именем и списком друзей
        //  кнопка релоад - для того, чтобы показать других друзей
        //иначе выводим сообщение о том, что все плохо
        //  и предлагаем залогиниться еще




    </script>

    <button onclick="getFriends()">Показать друзей</button>
    <button onclick="getToken()">Токен</button>
    <div class="wide_column_wrap" id="friend_list_wrapper">
        <div class="wide_column" id="wide_column">
            <div id="friends" class="page_block clear_fix">
                <div id="friends_list" class="friends_list">
                    <div class="friends_list_bl" id="friends_container">
                    </div>
                </div>
                <div id="page_end"></div>
            </div>
        </div>
    </div>
</body>
</html>
